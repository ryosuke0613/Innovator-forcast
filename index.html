<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>案件管理ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    </style>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase SDKをwindowオブジェクトに渡してBabelから利用可能にする
        window.Firebase = {
            initializeApp,
            getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, serverTimestamp, writeBatch
        };
    </script>
    
    <script type="text/babel" data-type="module">
        // ライブラリをwindowからインポート
        const { useState, useEffect, useMemo, useRef } = React;
        const { initializeApp } = window.Firebase;
        const { getAuth, signInAnonymously, onAuthStateChanged } = window.Firebase;
        const { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, serverTimestamp, writeBatch } = window.Firebase;

        // アイコンをインラインSVGとして定義
        const PlusCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>;
        const MoreHorizontal = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>;
        const FileDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
        const Trash2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
        const Edit = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;
        const Flame = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></svg>;
        const TrendingUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>;
        const FileUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
        const Target = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>;
        const AlertTriangle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>;
        const X = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAKf7IrUh9w522TaENZ2l12z8TyPTKH4UE",
            authDomain: "innovator-forcast.firebaseapp.com",
            projectId: "innovator-forcast",
            storageBucket: "innovator-forcast.appspot.com",
            messagingSenderId: "816397879781",
            appId: "1:816397879781:web:0ab4ee3dff546a353dc70c"
        };
        
        // --- 定数 ---
        const GOAL_TOTAL = 500000000;
        const GOAL_TRAINING = 100000000;
        const ACTION_PLAN_ALERT_DAYS = 7;

        const PROBABILITY_OPTIONS = { 'S (100%)': 100, 'A (80%)': 80, 'B (50%)': 50, 'C (30%)': 30, 'D (10%)': 10, 'E (0%)': 0 };
        const PROBABILITY_VALUES = Object.values(PROBABILITY_OPTIONS);
        const PROBABILITY_RANKS = { 0: 'E', 10: 'D', 30: 'C', 50: 'B', 80: 'A', 100: 'S', };
        const PROBABILITY_FROM_RANK = { 'S': 100, 'A': 80, 'B': 50, 'C': 30, 'D': 10, 'E': 0 };
        const PROBABILITY_COLORS = { 'E': 'bg-gray-800 text-gray-300', 'D': 'bg-gray-600 text-gray-100', 'C': 'bg-blue-800 text-blue-100', 'B': 'bg-yellow-800 text-yellow-100', 'A': 'bg-orange-800 text-orange-100', 'S': 'bg-green-800 text-green-100', };
        const DEAL_TYPE_OPTIONS = [ 'BM（6ヶ月）以上', 'BM（3ヶ月）', 'BM単発', '研修', 'AGT（450万以上）', 'AGT（ノーマル）', 'MD' ];
        const OWNER_OPTIONS = [ '礒谷', '佑太', '亮介', '髙橋', '果鈴', 'コンサルチーム', 'AGTチーム' ];
        const STAGE_OPTIONS = ['ヒアリング', '提案', '交渉・クロージング', '受注', '失注', 'その他'];
        
        // --- メインアプリケーションコンポーネント ---
        function App() {
            const [db, setDb] = useState(null);
            const [user, setUser] = useState(null);
            const [appState, setAppState] = useState('loading'); // loading, ready, error
            const [authError, setAuthError] = useState(null);
            const [deals, setDeals] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentDeal, setCurrentDeal] = useState(null);
            const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
            const [dealToDelete, setDealToDelete] = useState(null);
            const [isSummaryVisible, setIsSummaryVisible] = useState(false);
            const [dealsToImport, setDealsToImport] = useState(null);
            const [importError, setImportError] = useState(null);
            
            useEffect(() => {
                try {
                    const app = initializeApp(firebaseConfig);
                    const firestoreDb = getFirestore(app);
                    const firebaseAuth = getAuth(app);
                    setDb(firestoreDb);
                    
                    const unsubscribe = onAuthStateChanged(firebaseAuth, async (currentUser) => {
                        if (currentUser) {
                            setUser(currentUser);
                            setAppState('ready');
                        } else {
                            try {
                                await signInAnonymously(firebaseAuth);
                            } catch (error) {
                                console.error("Firebase Anonymous Sign-in error:", error);
                                setAuthError(error);
                                setAppState('error');
                            }
                        }
                    });
                    return () => unsubscribe();
                } catch(e) {
                    console.error("Firebase initialization failed.", e);
                    setAuthError(e);
                    setAppState('error');
                }
            }, []);
            
            useEffect(() => {
                if (appState === 'ready' && db && user) {
                    const dealsCollectionPath = `/deals`;
                    const q = query(collection(db, dealsCollectionPath));
                    
                    const unsubscribe = onSnapshot(q, (querySnapshot) => {
                        const dealsData = querySnapshot.docs.map(doc => {
                             const data = doc.data();
                             const actionPlan = data.actionPlan ? { 
                                 text: data.actionPlan.text || '',
                                 updatedAt: data.actionPlan.updatedAt?.toDate() 
                             } : { text: '', updatedAt: null };
                             return { id: doc.id, ...data, creationDate: data.creationDate?.toDate(), expectedCloseDate: data.expectedCloseDate?.toDate(), createdAt: data.createdAt?.toDate(), actionPlan: actionPlan };
                        });
                        dealsData.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                        setDeals(dealsData);
                    }, (error) => {
                        console.error("Error fetching deals: ", error);
                    });
                    
                    return () => unsubscribe();
                }
            }, [appState, db, user]);

            if (appState === 'loading') {
                return <LoadingSpinner />;
            }

            if (appState === 'error') {
                return <AuthError error={authError} />;
            }
            
            const handleOpenModal = (deal = null) => { setCurrentDeal(deal); setIsModalOpen(true); };
            const handleCloseModal = () => { setIsModalOpen(false); setCurrentDeal(null); };
            
            const handleSaveDeal = async (dealData) => {
                if (!db || !user) {
                    throw new Error("データベースまたはユーザーが初期化されていません。");
                }
                const dealsCollectionPath = `/deals`;
                if (currentDeal && currentDeal.id) {
                    const dealRef = doc(db, dealsCollectionPath, currentDeal.id);
                    await setDoc(dealRef, { ...dealData, updatedAt: serverTimestamp() }, { merge: true });
                } else {
                    await addDoc(collection(db, dealsCollectionPath), { ...dealData, createdAt: serverTimestamp(), userId: user.uid, });
                }
            };
            
            const handleDeleteRequest = (dealId) => { setDealToDelete(dealId); setIsConfirmModalOpen(true); };
            const handleConfirmDelete = async () => {
                if (!db || !dealToDelete) return;
                try {
                    const dealRef = doc(db, `/deals`, dealToDelete);
                    await deleteDoc(dealRef);
                } catch (error) { console.error("Error deleting deal: ", error); }
                setIsConfirmModalOpen(false);
                setDealToDelete(null);
            };
            const handleCancelDelete = () => { setIsConfirmModalOpen(false); setDealToDelete(null); };
            
            const exportToCSV = () => {
                if (deals.length === 0) return;
                const headers = ["案件名", "顧客名", "案件発生年月日", "案件種別", "フェーズ", "確度", "見込金額", "担当者", "受注予定年月日", "キーマイルストーン", "アクションプラン"];
                const csvString = [ headers.join(','), ...deals.map(deal => [
                        `"${deal.dealName || ''}"`,`"${deal.customerName || ''}"`,
                        deal.creationDate ? deal.creationDate.toLocaleDateString('ja-JP') : '',
                        `"${deal.dealType || ''}"`,`"${deal.stage || ''}"`,
                        `"${PROBABILITY_RANKS[deal.probability] || ''}"`, deal.amount || 0,
                        `"${(Array.isArray(deal.owner) ? deal.owner.join(',') : deal.owner) || ''}"`,
                        deal.expectedCloseDate ? deal.expectedCloseDate.toLocaleDateString('ja-JP') : '',
                        `"${deal.keyMilestone || ''}"`, `"${deal.actionPlan?.text || ''}"`,
                    ].join(','))
                ].join('\n');
                const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "案件管理表.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            
            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setImportError(null);
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    try {
                        const parsedDeals = parseCSV(text);
                        setDealsToImport(parsedDeals);
                    } catch (error) { setImportError(error.message); setDealsToImport(null); }
                };
                reader.onerror = () => { setImportError("ファイルの読み込みに失敗しました。"); };
                reader.readAsText(file, 'UTF-8');
                event.target.value = '';
            };
            
            const parseCSV = (text) => {
                const lines = text.split(/\r\n|\n/).filter(line => line.trim() !== '');
                if (lines.length < 2) throw new Error("CSVファイルにデータがありません。");
                const headers = lines[0].split(',').map(h => h.trim());
                const requiredHeaders = ["案件名", "顧客名", "案件発生年月日", "案件種別", "フェーズ", "確度", "見込金額", "担当者", "受注予定年月日", "キーマイルストーン", "アクションプラン"];
                const headerMap = {};
                requiredHeaders.forEach(rh => {
                    const index = headers.findIndex(h => h === rh);
                    if(index === -1) throw new Error(`必須ヘッダーが見つかりません: ${rh}`);
                    headerMap[rh] = index;
                });
                return lines.slice(1).map((line, i) => {
                    const values = line.split(',');
                    const probRank = values[headerMap['確度']].trim().toUpperCase();
                    const probability = PROBABILITY_FROM_RANK[probRank];
                    if(probability === undefined) throw new Error(`${i+2}行目: 確度の値「${probRank}」は無効です。S,A,B,C,D,Eのいずれかを入力してください。`);
                    return {
                        dealName: values[headerMap['案件名']].trim(), customerName: values[headerMap['顧客名']].trim(),
                        creationDate: new Date(values[headerMap['案件発生年月日']].trim()), dealType: values[headerMap['案件種別']].trim(),
                        stage: values[headerMap['フェーズ']].trim(), probability,
                        amount: parseInt(values[headerMap['見込金額']].trim()) || 0, 
                        owner: values[headerMap['担当者']].trim().split(',').map(name => name.trim()).filter(Boolean),
                        expectedCloseDate: new Date(values[headerMap['受注予定年月日']].trim()),
                        keyMilestone: values[headerMap['キーマイルストーン']].trim(),
                        actionPlan: { text: values[headerMap['アクションプラン']].trim(), updatedAt: serverTimestamp(), }
                    };
                });
            };
            
            const handleConfirmImport = async () => {
                if (!dealsToImport || !db || !user) return;
                const batch = writeBatch(db);
                const dealsCollectionPath = `/deals`;
                dealsToImport.forEach(deal => {
                    const docRef = doc(collection(db, dealsCollectionPath));
                    batch.set(docRef, { ...deal, createdAt: serverTimestamp(), userId: user.uid });
                });
                try { await batch.commit(); setDealsToImport(null);
                } catch (error) { console.error("Error importing deals:", error); setImportError("データのインポート中にエラーが発生しました。"); }
            };
            
            return (
                <div className="bg-gray-900 min-h-screen font-sans text-gray-200">
                    <div className="container mx-auto p-4 sm:p-6 lg:p-8">
                        <Header onNewDeal={() => handleOpenModal()} onExport={exportToCSV} onImport={handleFileChange} userId={user?.uid}/>
                        <DashboardSummary deals={deals} />
                        <GoalSummary deals={deals} />
                        <div className="my-6">
                            <div className="flex justify-end">
                                <Button variant="outline" onClick={() => setIsSummaryVisible(!isSummaryVisible)}>
                                    <TrendingUp className="mr-2 h-4 w-4" />
                                    {isSummaryVisible ? '集計を隠す' : '集計を表示する'}
                                </Button>
                            </div>
                            {isSummaryVisible && ( <div className="mt-4"><SummaryView deals={deals} /></div> )}
                        </div>
                        <div className="mt-6 bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                             <DealTable deals={deals} onEdit={handleOpenModal} onDelete={handleDeleteRequest} />
                        </div>
                    </div>
                    {isModalOpen && <DealModal deal={currentDeal} onSave={handleSaveDeal} onClose={handleCloseModal} />}
                    {isConfirmModalOpen && <ConfirmationModal onConfirm={handleConfirmDelete} onCancel={handleCancelDelete} message="この案件を本当に削除しますか？一度削除すると元に戻せません。" />}
                    {(dealsToImport || importError) && <ImportModal deals={dealsToImport} error={importError} onConfirm={handleConfirmImport} onClose={() => { setDealsToImport(null); setImportError(null); }} />}
                </div>
            );
        }
        
        // --- 子コンポーネント ---
        function AuthError({ error }) {
            let title = "Firebase 認証エラー";
            let message = "アプリの実行中に予期せぬ認証エラーが発生しました。";
            let solution = <p>コンソールでエラーコードを確認してください: <code className="bg-gray-700 p-1 rounded">{error?.code || '不明なエラー'}</code></p>;

            if (error?.code === 'auth/configuration-not-found') {
                title = "Firebase 認証設定が必要です";
                message = "このアプリは匿名認証を使用しますが、Firebaseプロジェクトで有効になっていないようです。";
                solution = (
                    <div>
                        <p className="font-semibold mb-2">解決するには、以下の手順に従ってください：</p>
                        <ol className="list-decimal list-inside space-y-2">
                            <li>Firebaseコンソールを開き、あなたのプロジェクト (<code className="bg-gray-700 p-1 rounded">{firebaseConfig.projectId}</code>) を選択します。</li>
                            <li>左のメニューから「Authentication」をクリックします。</li>
                            <li>「Sign-in method」タブ（または「利用開始」）を選択します。</li>
                            <li>プロバイダのリストから「匿名」をクリックします。</li>
                            <li>表示されたスイッチを「有効にする」に切り替え、「保存」をクリックします。</li>
                        </ol>
                        <p className="mt-4">設定後、このページを再読み込みしてください。</p>
                    </div>
                );
            }

            return (
                <div className="text-white flex items-center justify-center min-h-screen p-4">
                    <div className="bg-red-900/50 border border-red-700 text-red-200 p-8 rounded-lg max-w-2xl mx-auto">
                        <h2 className="text-2xl font-bold mb-4">{title}</h2>
                        <p className="mb-4">{message}</p>
                        <div className="text-sm text-red-100 bg-red-800/50 p-4 rounded-md">
                            {solution}
                        </div>
                    </div>
                </div>
            );
        }

        function Header({ onNewDeal, onExport, onImport, userId }) {
            const fileInputRef = useRef(null);
            return (
                <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                    <div className="flex items-center space-x-3">
                        <Flame className="text-orange-500 h-10 w-10" />
                        <div>
                            <h1 className="text-3xl font-bold text-white">案件管理ダッシュボード</h1>
                            <p className="text-sm text-gray-400 mt-1"> ユーザーID: <span className="font-mono bg-gray-700 text-gray-300 px-1 rounded">{userId || '読み込み中...'}</span></p>
                        </div>
                    </div>
                    <div className="flex items-center space-x-2 mt-4 sm:mt-0">
                        <input type="file" ref={fileInputRef} onChange={onImport} accept=".csv" className="hidden" />
                        <Button onClick={() => fileInputRef.current.click()} variant="outline"><FileUp className="mr-2 h-4 w-4" />CSVインポート</Button>
                        <Button onClick={onExport} variant="outline"><FileDown className="mr-2 h-4 w-4" />CSVエクスポート</Button>
                        <Button onClick={onNewDeal}><PlusCircle className="mr-2 h-4 w-4" />新規案件の追加</Button>
                    </div>
                </header>
            );
        }
        
        function DashboardSummary({ deals }) {
            const openDeals = deals.filter(deal => deal.stage !== '受注' && deal.stage !== '失注');
            const formatCurrency = (value) => new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(value);
            return (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <Card title="合計見込金額 (進行中)" value={formatCurrency(openDeals.reduce((sum, deal) => sum + (Number(deal.amount) || 0), 0))} />
                    <Card title="進行中の案件数" value={openDeals.length} />
                </div>
            );
        }
        
        function GoalSummary({ deals }) {
            const formatCurrency = (value) => new Intl.NumberFormat('ja-JP').format(value);
            const wonDeals = deals.filter(deal => deal.stage === '受注');
            const totalWonAmount = wonDeals.reduce((sum, deal) => sum + (Number(deal.amount) || 0), 0);
            const trainingWonAmount = wonDeals.filter(deal => deal.dealType === '研修').reduce((sum, deal) => sum + (Number(deal.amount) || 0), 0);
            const gapTotal = GOAL_TOTAL - totalWonAmount;
            const gapTraining = GOAL_TRAINING - trainingWonAmount;
            const progressTotal = Math.min((totalWonAmount / GOAL_TOTAL) * 100, 100);
            const progressTraining = Math.min((trainingWonAmount / GOAL_TRAINING) * 100, 100);
            return (
                <div className="mt-4 bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6">
                    <h3 className="text-lg font-bold text-white mb-4 flex items-center"><Target className="mr-2 text-orange-400" />10期目標達成状況</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 className="font-semibold text-gray-300">全体目標: {formatCurrency(GOAL_TOTAL)}円</h4>
                            <div className="mt-2">
                                <div className="flex justify-between text-sm font-mono">
                                    <span className="text-green-400">受注済: {formatCurrency(totalWonAmount)}円 ({progressTotal.toFixed(1)}%)</span>
                                    <span className="text-red-400">GAP: {formatCurrency(gapTotal)}円</span>
                                </div>
                                <div className="w-full bg-gray-700 rounded-full h-2.5 mt-1"><div className="bg-green-500 h-2.5 rounded-full" style={{ width: `${progressTotal}%` }}></div></div>
                            </div>
                        </div>
                        <div>
                            <h4 className="font-semibold text-gray-300">研修目標: {formatCurrency(GOAL_TRAINING)}円</h4>
                            <div className="mt-2">
                                <div className="flex justify-between text-sm font-mono">
                                    <span className="text-blue-400">受注済 (研修): {formatCurrency(trainingWonAmount)}円 ({progressTraining.toFixed(1)}%)</span>
                                    <span className="text-red-400">GAP: {formatCurrency(gapTraining)}円</span>
                                </div>
                                <div className="w-full bg-gray-700 rounded-full h-2.5 mt-1"><div className="bg-blue-500 h-2.5 rounded-full" style={{ width: `${progressTraining}%` }}></div></div>
                            </div>
                        </div>
                    </div>
                    <div className="mt-4 pt-4 border-t border-gray-700 text-center">
                        <h4 className="text-xl font-bold text-white">受注合計金額</h4>
                        <p className="text-3xl font-mono text-orange-400 mt-1">{formatCurrency(totalWonAmount)}円</p>
                    </div>
                </div>
            );
        }

        function Card({ title, value }) {
            return (
                <div className="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h3 className="text-sm font-medium text-gray-400">{title}</h3>
                    <p className="mt-1 text-3xl font-semibold text-white">{value}</p>
                </div>
            );
        }

        function SummaryView({ deals }) {
            const [view, setView] = useState('owner');
            const formatCurrency = (value) => new Intl.NumberFormat('ja-JP').format(value);
            const summaryByOwner = useMemo(() => {
                const summary = {};
                OWNER_OPTIONS.forEach(owner => {
                    summary[owner] = { total: { count: 0, amount: 0 } };
                    PROBABILITY_VALUES.forEach(prob => { summary[owner][prob] = { count: 0, amount: 0 }; });
                });
                deals.forEach(deal => {
                    const owners = Array.isArray(deal.owner) ? deal.owner : [deal.owner];
                    owners.forEach(owner => {
                        if (summary[owner] && summary[owner][deal.probability] !== undefined) {
                            summary[owner][deal.probability].count++;
                            summary[owner][deal.probability].amount += (deal.amount || 0);
                            summary[owner].total.count++;
                            summary[owner].total.amount += (deal.amount || 0);
                        }
                    });
                });
                return summary;
            }, [deals]);
            const summaryByProb = useMemo(() => {
                const summary = {};
                PROBABILITY_VALUES.forEach(prob => {
                    summary[prob] = { total: { count: 0, amount: 0 } };
                    OWNER_OPTIONS.forEach(owner => { summary[prob][owner] = { count: 0, amount: 0 }; });
                });
                deals.forEach(deal => {
                    const owners = Array.isArray(deal.owner) ? deal.owner : [deal.owner];
                     if (summary[deal.probability] !== undefined) {
                        summary[deal.probability].total.count++;
                        summary[deal.probability].total.amount += (deal.amount || 0);
                        owners.forEach(owner => {
                            if (summary[deal.probability][owner]) {
                                summary[deal.probability][owner].count++;
                                summary[deal.probability][owner].amount += (deal.amount || 0);
                            }
                        });
                    }
                });
                return summary;
            }, [deals]);
            return (
                <div className="bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6">
                    <div className="flex border-b border-gray-700 mb-4">
                        <button onClick={() => setView('owner')} className={`px-4 py-2 text-sm font-medium ${view === 'owner' ? 'border-b-2 border-orange-500 text-white' : 'text-gray-400 hover:text-white'}`}>担当者別 集計</button>
                        <button onClick={() => setView('prob')} className={`px-4 py-2 text-sm font-medium ${view === 'prob' ? 'border-b-2 border-orange-500 text-white' : 'text-gray-400 hover:text-white'}`}>確度別 集計</button>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                        {view === 'owner' && Object.entries(summaryByOwner).map(([owner, stats]) => (
                            <div key={owner} className="bg-gray-900/50 rounded-lg p-4">
                                <h4 className="font-bold text-white mb-3">{owner}</h4>
                                <table className="w-full text-xs">
                                    <thead><tr className="border-b border-gray-700"><th className="text-left font-medium text-gray-400 pb-1">確度</th><th className="text-right font-medium text-gray-400 pb-1">件数</th><th className="text-right font-medium text-gray-400 pb-1">合計金額 (円)</th></tr></thead>
                                    <tbody>{Object.entries(stats).filter(([key]) => key !== 'total').map(([prob, data]) => (<tr key={prob}><td><span className={`inline-block text-center w-8 px-1 py-0.5 my-0.5 rounded-full text-xs font-semibold ${PROBABILITY_COLORS[PROBABILITY_RANKS[prob]] || ''}`}>{PROBABILITY_RANKS[prob]}</span></td><td className="text-right">{data.count}</td><td className="text-right font-mono">{formatCurrency(data.amount)}</td></tr>))}</tbody>
                                    <tfoot><tr className="border-t border-gray-700 font-bold"><td className="pt-1">合計</td><td className="text-right pt-1">{stats.total.count}</td><td className="text-right font-mono pt-1">{formatCurrency(stats.total.amount)}</td></tr></tfoot>
                                </table>
                            </div>
                        ))}
                        {view === 'prob' && Object.entries(PROBABILITY_OPTIONS).map(([label, probValue]) => {
                            const rank = PROBABILITY_RANKS[probValue];
                            const stats = summaryByProb[probValue];
                            return (
                                <div key={probValue} className="bg-gray-900/50 rounded-lg p-4">
                                    <h4 className="font-bold text-white mb-3 flex items-center"><span className={`inline-block text-center w-8 mr-2 px-1 py-0.5 rounded-full text-xs font-semibold ${PROBABILITY_COLORS[rank] || ''}`}>{rank}</span>確度 ({label})</h4>
                                    <table className="w-full text-xs">
                                        <thead><tr className="border-b border-gray-700"><th className="text-left font-medium text-gray-400 pb-1">担当者</th><th className="text-right font-medium text-gray-400 pb-1">件数</th><th className="text-right font-medium text-gray-400 pb-1">合計金額 (円)</th></tr></thead>
                                        <tbody>{Object.entries(stats).filter(([key]) => key !== 'total').map(([owner, data]) => (<tr key={owner}><td>{owner}</td><td className="text-right">{data.count}</td><td className="text-right font-mono">{formatCurrency(data.amount)}</td></tr>))}</tbody>
                                        <tfoot><tr className="border-t border-gray-700 font-bold"><td className="pt-1">合計</td><td className="text-right pt-1">{stats.total.count}</td><td className="text-right font-mono pt-1">{formatCurrency(stats.total.amount)}</td></tr></tfoot>
                                    </table>
                                </div>
                            )})}
                    </div>
                </div>
            );
        }

        function DealTable({ deals, onEdit, onDelete }) {
            if (deals.length === 0) { return (<div className="text-center py-16"><p className="text-gray-400">案件がまだありません。</p><p className="text-gray-500 text-sm mt-2">「新規案件の追加」ボタンから最初の案件を登録しましょう。</p></div>); }
            return (
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left">
                        <thead className="bg-gray-700/50 border-b border-gray-600"><tr><th className="px-4 py-3 font-medium text-gray-300">案件詳細</th><th className="px-4 py-3 font-medium text-gray-300">ステータス</th><th className="px-4 py-3 font-medium text-gray-300">金額・日付</th><th className="px-4 py-3 font-medium text-gray-300">アクション</th><th className="px-4 py-3 font-medium text-gray-300"></th></tr></thead>
                        <tbody className="divide-y divide-gray-700">{deals.map(deal => (<DealRow key={deal.id} deal={deal} onEdit={onEdit} onDelete={onDelete} />))}</tbody>
                    </table>
                </div>
            );
        }

        function DealRow({ deal, onEdit, onDelete }) {
            const rank = PROBABILITY_RANKS[deal.probability] || 'N/A';
            const STAGE_COLORS = { 'ヒアリング': 'bg-indigo-800 text-indigo-100', '提案': 'bg-purple-800 text-purple-100', '交渉・クロージング': 'bg-yellow-800 text-yellow-100', '受注': 'bg-green-800 text-green-100', '失注': 'bg-red-800 text-red-100', 'その他': 'bg-gray-700 text-gray-200', };
            const isActionPlanOutdated = useMemo(() => {
                if (deal.stage === '受注' || deal.stage === '失注' || !deal.actionPlan?.updatedAt) { return false; }
                const diffDays = (new Date().getTime() - deal.actionPlan.updatedAt.getTime()) / (1000 * 3600 * 24);
                return diffDays > ACTION_PLAN_ALERT_DAYS;
            }, [deal.stage, deal.actionPlan?.updatedAt]);
            return (
                <tr className="hover:bg-gray-700/50">
                    <td className="px-4 py-4 align-top"><p className="font-bold text-white">{deal.dealName}</p><p className="text-xs text-gray-400">{deal.customerName}</p><p className="text-xs text-gray-500 mt-1">{deal.dealType}</p></td>
                    <td className="px-4 py-4 align-top"><div className="flex flex-col space-y-2"><p className="text-sm text-gray-300">{(Array.isArray(deal.owner) ? deal.owner.join(', ') : deal.owner) || '未設定'}</p><span className={`w-fit px-2 py-1 rounded-full text-xs font-semibold ${STAGE_COLORS[deal.stage] || STAGE_COLORS['その他']}`}>{deal.stage}</span><span className={`w-fit px-2 py-1 rounded-full text-xs font-semibold ${PROBABILITY_COLORS[rank] || PROBABILITY_COLORS['D']}`}>確度: {rank}</span></div></td>
                    <td className="px-4 py-4 align-top"><p className="font-mono text-white">{Number(deal.amount || 0).toLocaleString()} 円</p><p className="text-xs text-gray-400 mt-1">発生: {deal.creationDate ? deal.creationDate.toLocaleDateString() : '未設定'}</p><p className="text-xs text-gray-400">受注予定: {deal.expectedCloseDate ? deal.expectedCloseDate.toLocaleDateString() : '未設定'}</p></td>
                    <td className="px-4 py-4 align-top max-w-xs">
                        <div><p className="font-semibold text-xs text-gray-400">キーマイルストーン</p><p className="text-sm text-gray-300 whitespace-pre-wrap">{deal.keyMilestone || '未設定'}</p></div>
                        <div className="mt-2">
                            <div className="flex items-center"><p className="font-semibold text-xs text-gray-400">アクションプラン</p>{isActionPlanOutdated && (<div className="flex items-center ml-2" title={`${ACTION_PLAN_ALERT_DAYS}日間更新がありません`}><AlertTriangle className="h-4 w-4 text-yellow-400 animate-pulse" /></div>)}</div>
                            <p className="text-sm text-gray-300 whitespace-pre-wrap">{deal.actionPlan?.text || '未設定'}</p>
                        </div>
                    </td>
                    <td className="px-4 py-4 align-top"><DropdownMenu onEdit={() => onEdit(deal)} onDelete={() => onDelete(deal.id)} /></td>
                </tr>
            );
        }

        function DropdownMenu({ onEdit, onDelete }) {
            const [isOpen, setIsOpen] = useState(false);
            const menuRef = useRef(null);
            useEffect(() => {
                const handleClickOutside = (event) => { if (menuRef.current && !menuRef.current.contains(event.target)) { setIsOpen(false); } };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);
            return (
                <div className="relative"><button onClick={() => setIsOpen(!isOpen)} className="p-2 rounded-full hover:bg-gray-600"><MoreHorizontal size={18} /></button>
                    {isOpen && (<div className="absolute right-0 mt-2 w-40 bg-gray-800 rounded-md shadow-lg z-10 border border-gray-700"><ul className="py-1"><li><button onClick={() => { onEdit(); setIsOpen(false); }} className="w-full text-left flex items-center px-4 py-2 text-sm text-gray-200 hover:bg-gray-700"><Edit className="mr-3 h-4 w-4" /> 編集</button></li><li><button onClick={() => { onDelete(); setIsOpen(false); }} className="w-full text-left flex items-center px-4 py-2 text-sm text-red-400 hover:bg-gray-700"><Trash2 className="mr-3 h-4 w-4" /> 削除</button></li></ul></div>)}
                </div>
            );
        }

        function DealModal({ deal, onSave, onClose }) {
            const [isSaving, setIsSaving] = useState(false);
            
            const getInitialOwners = () => {
                if (!deal?.owner) return [];
                if (Array.isArray(deal.owner)) return deal.owner;
                return [deal.owner];
            };

            const [formData, setFormData] = useState({
                dealName: deal?.dealName || '', customerName: deal?.customerName || '',
                creationDate: deal?.creationDate ? deal.creationDate.toISOString().split('T')[0] : new Date().toISOString().split('T')[0],
                dealType: deal?.dealType || DEAL_TYPE_OPTIONS[0], stage: deal?.stage || STAGE_OPTIONS[0],
                probability: deal?.probability ?? 0, amount: deal?.amount || '',
                owner: getInitialOwners(),
                expectedCloseDate: deal?.expectedCloseDate ? deal.expectedCloseDate.toISOString().split('T')[0] : '',
                keyMilestone: deal?.keyMilestone || '', 
                actionPlanText: deal?.actionPlan?.text || '',
            });
            
            const handleOwnerChange = (ownerName) => {
                setFormData(prev => {
                    const newOwners = prev.owner.includes(ownerName)
                        ? prev.owner.filter(name => name !== ownerName)
                        : [...prev.owner, ownerName];
                    return { ...prev, owner: newOwners };
                });
            };

            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (formData.owner.length === 0) {
                    alert("担当者を少なくとも1人選択してください。");
                    return;
                }
                setIsSaving(true);
                const { actionPlanText, ...restOfData } = formData;
                const dataToSave = {
                    ...restOfData, amount: Number(formData.amount) || 0, probability: Number(formData.probability),
                    creationDate: formData.creationDate ? new Date(formData.creationDate) : null,
                    expectedCloseDate: formData.expectedCloseDate ? new Date(formData.expectedCloseDate) : null,
                    actionPlan: { text: actionPlanText, updatedAt: serverTimestamp(), },
                };
                try {
                    await onSave(dataToSave);
                    onClose();
                } catch(error) {
                    console.error("保存に失敗しました:", error);
                    alert("エラー: 案件の保存に失敗しました。");
                } finally {
                    setIsSaving(false);
                }
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
                    <div className="bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl max-h-full flex flex-col border border-gray-700">
                        <div className="flex justify-between items-center p-4 border-b border-gray-700">
                            <h2 className="text-xl font-bold text-white">{deal ? '案件の編集' : '新規案件の追加'}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white"><X /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="flex-grow overflow-y-auto">
                            <div className="p-6 sm:p-8">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                    <Input label="案件名" name="dealName" value={formData.dealName} onChange={handleChange} required className="md:col-span-2" />
                                    <Input label="顧客名" name="customerName" value={formData.customerName} onChange={handleChange} required />
                                    <Input label="案件発生年月日" name="creationDate" type="date" value={formData.creationDate} onChange={handleChange} />
                                    <Select label="案件種別" name="dealType" value={formData.dealType} onChange={handleChange} className="md:col-span-2">{DEAL_TYPE_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}</Select>
                                    
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-gray-400 mb-2">担当者 (複数選択可)</label>
                                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                            {OWNER_OPTIONS.map(owner => (
                                                <label key={owner} className="flex items-center space-x-2 p-2 rounded-md bg-gray-700/50 hover:bg-gray-700 cursor-pointer">
                                                    <input type="checkbox" checked={formData.owner.includes(owner)} onChange={() => handleOwnerChange(owner)} className="h-4 w-4 rounded bg-gray-600 border-gray-500 text-orange-500 focus:ring-orange-500" />
                                                    <span>{owner}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>

                                    <Select label="フェーズ" name="stage" value={formData.stage} onChange={handleChange}>{STAGE_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}</Select>
                                    <Select label="確度" name="probability" value={formData.probability} onChange={handleChange}>{Object.entries(PROBABILITY_OPTIONS).map(([label, value]) => (<option key={value} value={value}>{label}</option>))}</Select>
                                    <Input label="見込金額 (円)" name="amount" type="number" value={formData.amount} onChange={handleChange} />
                                    <Input label="受注予定年月日" name="expectedCloseDate" type="date" value={formData.expectedCloseDate} onChange={handleChange} className="md:col-span-2"/>
                                    <div className="md:col-span-2 mt-4 pt-4 border-t border-gray-700"><Input label="キーマイルストーン" name="keyMilestone" value={formData.keyMilestone} onChange={handleChange} isTextarea /></div>
                                    <div className="md:col-span-2"><Input label="アクションプラン" name="actionPlanText" value={formData.actionPlanText} onChange={handleChange} isTextarea /></div>
                                </div>
                            </div>
                            <div className="bg-gray-900/50 px-6 py-4 flex justify-end space-x-3 border-t border-gray-700">
                                <Button type="button" variant="outline" onClick={onClose} disabled={isSaving}>キャンセル</Button>
                                <Button type="submit" disabled={isSaving}>{isSaving ? '保存中...' : '保存'}</Button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }
        
        function ConfirmationModal({ onConfirm, onCancel, message }) {
            return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"><div className="bg-gray-800 rounded-lg shadow-xl w-full max-w-md border border-gray-700"><div className="p-6"><div className="flex items-start"><div className="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-900/50 sm:mx-0 sm:h-10 sm:w-10"><AlertTriangle className="h-6 w-6 text-red-400"/></div><div className="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left"><h3 className="text-lg leading-6 font-medium text-white" id="modal-title">案件の削除</h3><div className="mt-2"><p className="text-sm text-gray-400">{message}</p></div></div></div></div><div className="bg-gray-900/50 px-6 py-4 flex justify-end space-x-3"><Button type="button" variant="outline" onClick={onCancel}>キャンセル</Button><Button type="button" onClick={onConfirm} variant="danger">削除する</Button></div></div></div>);
        }

        function ImportModal({ deals, error, onConfirm, onClose }) {
            return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"><div className="bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col border border-gray-700"><div className="p-6 border-b border-gray-700"><h2 className="text-xl font-bold text-white">CSVインポート確認</h2></div><div className="p-6 flex-grow overflow-y-auto">{error && (<div className="bg-red-900/50 border border-red-700 text-red-300 p-4 rounded-md"><h3 className="font-bold">インポートエラー</h3><p className="mt-2 text-sm">{error}</p></div>)}{deals && deals.length > 0 && (<div><p className="text-gray-400 mb-4">{deals.length}件の案件がインポートされます。内容を確認してください。</p><div className="overflow-x-auto"><table className="w-full text-xs text-left"><thead className="bg-gray-700/50"><tr><th className="px-4 py-2 font-medium text-gray-300">案件名</th><th className="px-4 py-2 font-medium text-gray-300">顧客名</th><th className="px-4 py-2 font-medium text-gray-300">担当者</th><th className="px-4 py-2 font-medium text-gray-300">確度</th><th className="px-4 py-2 font-medium text-gray-300 text-right">見込金額</th></tr></thead><tbody className="divide-y divide-gray-700">{deals.map((deal, index) => (<tr key={index} className="hover:bg-gray-700/50"><td className="px-4 py-2">{deal.dealName}</td><td className="px-4 py-2">{deal.customerName}</td><td className="px-4 py-2">{deal.owner.join(', ')}</td><td className="px-4 py-2">{PROBABILITY_RANKS[deal.probability]}</td><td className="px-4 py-2 text-right font-mono">{deal.amount.toLocaleString()}</td></tr>))}</tbody></table></div></div>)}</div><div className="bg-gray-900/50 px-6 py-4 flex justify-end space-x-3 border-t border-gray-700"><Button type="button" variant="outline" onClick={onClose}>キャンセル</Button><Button type="button" onClick={onConfirm} variant="primary" disabled={!deals || deals.length === 0}>インポート実行</Button></div></div></div>);
        }

        function Input({ label, className, isTextarea, ...props }) {
            const commonProps = { ...props, id: props.id || props.name, className: "w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-orange-500 text-white" };
            return (<div className={className}><label htmlFor={props.id || props.name} className="block text-sm font-medium text-gray-400 mb-1">{label}</label>{isTextarea ? (<textarea {...commonProps} rows="3"></textarea>) : (<input {...commonProps} />)}</div>);
        }

        function Select({ label, children, className, ...props }) {
            return (<div className={className}><label htmlFor={props.id || props.name} className="block text-sm font-medium text-gray-400 mb-1">{label}</label><select {...props} id={props.id || props.name} className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-orange-500 text-white">{children}</select></div>);
        }

        function Button({ children, onClick, type = 'button', variant = 'primary', disabled = false }) {
            const baseClasses = 'px-4 py-2 rounded-md font-semibold text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 flex items-center justify-center transition-colors';
            const variants = { primary: 'bg-orange-600 text-white hover:bg-orange-700 focus:ring-orange-500', outline: 'bg-gray-800 border border-gray-600 text-gray-300 hover:bg-gray-700 focus:ring-orange-500', danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500', };
            const disabledClasses = 'opacity-50 cursor-not-allowed';
            return (<button type={type} onClick={onClick} className={`${baseClasses} ${variants[variant]} ${disabled ? disabledClasses : ''}`} disabled={disabled}>{children}</button>);
        }
        
        function LoadingSpinner() {
            return (<div className="flex justify-center items-center py-20 min-h-screen"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"></div></div>);
        }

        // アプリをマウント
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
